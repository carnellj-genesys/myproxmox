# Proxmox VM Deployment with Terraform

This directory contains Terraform configurations to deploy VMs to Proxmox VE using the Debian base template created by Packer.

## Overview

This Terraform configuration automates the deployment of VMs by cloning from the Debian base template generated by your Packer setup. It provides a flexible way to create multiple VMs with different configurations while maintaining consistency.

## Prerequisites

1. **Terraform installed** - Version 1.0 or later
2. **Proxmox VE access** - API access to your Proxmox cluster
3. **Base template** - Debian base template created by Packer (VM ID 9000 by default)
4. **SSH key** - Your SSH key for VM access

## Files

- **`main.tf`** - Main Terraform configuration
- **`variables.tf`** - Variable definitions
- **`terraform.tfvars.example`** - Example configuration file
- **`README.md`** - This documentation

## Quick Start

### 1. Configure Variables

Copy the example configuration and customize it:

```bash
cp terraform.tfvars.example terraform.tfvars
```

Edit `terraform.tfvars` with your Proxmox credentials and desired VM configuration.

### 2. Initialize Terraform

```bash
terraform init
```

### 3. Plan the Deployment

```bash
terraform plan
```

### 4. Apply the Configuration

```bash
terraform apply
```

## Configuration

### Proxmox Connection

Set these variables in your `terraform.tfvars`:

```hcl
proxmox_api_url = "https://192.168.1.101:8006/api2/json"
proxmox_username = "your_username@pve"
proxmox_password = "your_password"
proxmox_node = "pve"
```

### Template Configuration

The `template_vm_id` should match the VM ID of the template created by Packer. By default, this is set to 9000, but you should verify the actual ID in your Proxmox interface.

### VM Configuration

Customize your VM with these variables:

```hcl
vm_name = "my-debian-vm"
vm_id = 1001
vm_cpu_cores = 2
vm_memory = 4096  # 4GB RAM
vm_disk_size = 30 # 30GB disk
```

## How It Works

1. **Template Discovery**: Terraform finds the Debian base template using the specified VM ID
2. **VM Cloning**: Creates a new VM by cloning the template (full clone)
3. **Resource Configuration**: Applies CPU, memory, disk, and network settings
4. **VM Deployment**: Starts the VM and waits for it to be ready

## Resource Allocation

### Default Configuration
- **CPU**: 2 cores, KVM64 type
- **Memory**: 2GB RAM
- **Disk**: 20GB on local-lvm storage
- **Network**: VirtIO adapter on vmbr0 bridge

### Customization Options
- Adjust CPU cores and type
- Modify memory allocation
- Change disk size and storage location
- Configure network settings
- Add custom tags

## Multiple VM Deployments

To deploy multiple VMs, you can:

### Option 1: Use Terraform Workspaces
```bash
terraform workspace new web-server
terraform workspace new database
# Configure each workspace with different variables
```

### Option 2: Create Multiple Configuration Files
Copy the configuration and modify for different use cases:
- `web-server.tf` - Web server configuration
- `database.tf` - Database server configuration
- `monitoring.tf` - Monitoring server configuration

### Option 3: Use Terraform Modules
Create a reusable module for VM deployment and call it multiple times with different parameters.

## Security Considerations

- **Credentials**: Store sensitive credentials in environment variables or secure secret management
- **Network**: Ensure VMs are deployed to appropriate network segments
- **Access**: Use SSH keys for secure VM access
- **Tags**: Apply appropriate tags for security classification

## Troubleshooting

### Common Issues

1. **Template Not Found**
   - Verify the `template_vm_id` matches your Packer-generated template
   - Check that the template exists and is accessible

2. **Authentication Failed**
   - Verify Proxmox credentials
   - Check API permissions for the user
   - Ensure the API endpoint is correct

3. **Resource Allocation Failed**
   - Check available resources on the Proxmox node
   - Verify storage pool has sufficient space
   - Ensure the specified VM ID is available

4. **Network Issues**
   - Verify the network bridge exists
   - Check network configuration on the Proxmox host

### Debug Mode

Enable Terraform debug logging:
```bash
export TF_LOG=DEBUG
terraform apply
```

## Advanced Usage

### Custom Provisioning

Add additional provisioning after VM creation:

```hcl
# Example: Install additional packages via SSH
resource "null_resource" "vm_provisioning" {
  depends_on = [proxmox_virtual_environment_vm.debian_vm]
  
  connection {
    host     = proxmox_virtual_environment_vm.debian_vm.ipv4_addresses[0]
    user     = "root"
    private_key = file("~/.ssh/id_rsa")
  }

  provisioner "remote-exec" {
    inline = [
      "apt-get update",
      "apt-get install -y nginx",
      "systemctl enable nginx"
    ]
  }
}
```

### Integration with CI/CD

Use this configuration in your CI/CD pipeline:

```yaml
# Example GitHub Actions workflow
- name: Deploy VM
  run: |
    cd tofu
    terraform init
    terraform apply -auto-approve \
      -var="vm_name=${{ github.event.inputs.vm_name }}" \
      -var="vm_id=${{ github.event.inputs.vm_id }}"
```

## Maintenance

### Updating VMs
- Modify the configuration and run `terraform plan` and `terraform apply`
- Terraform will update the VM configuration as needed

### Destroying VMs
```bash
terraform destroy
```

### Template Updates
When you update the base template with Packer:
1. Update the `template_vm_id` if it changes
2. Consider recreating VMs to use the new template
3. Use `terraform taint` to force recreation if needed

## Next Steps

1. **Customize the configuration** for your specific needs
2. **Create multiple VM configurations** for different use cases
3. **Integrate with your infrastructure** (load balancers, monitoring, etc.)
4. **Automate deployments** with CI/CD pipelines
5. **Implement backup strategies** for your VMs 